<!DOCTYPE html>
<html lang="zh-HK">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <title>StoreKeeper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Babel for JSX support in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                50: '#f0f9ff',
                100: '#e0f2fe',
                500: '#0ea5e9',
                600: '#0284c7',
                700: '#0369a1',
              }
            },
            animation: {
              'fade-in': 'fadeIn 0.2s ease-out',
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0', transform: 'translateY(-5px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              }
            }
          }
        }
      }
    </script>
    <style>
      /* Base Mobile Reset */
      html, body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden; /* Prevent body scroll, handled by React root */
        background-color: #f9fafb; /* gray-50 match */
        
        /* Font Smoothing */
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        
        /* Mobile Interaction Fixes */
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        overscroll-behavior: none;
        
        /* Prevent accidental text selection on UI elements */
        -webkit-user-select: none;
        user-select: none;
      }

      /* Allow text selection on inputs and textareas */
      input, textarea, [contenteditable] {
        -webkit-user-select: text;
        user-select: text;
      }

      /* Safe Area Utilities */
      .pb-safe {
        padding-bottom: env(safe-area-inset-bottom, 20px);
      }
      .pt-safe {
        padding-top: env(safe-area-inset-top, 0px);
      }

      /* Custom Slim Scrollbar */
      ::-webkit-scrollbar {
        width: 5px;
        height: 5px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1; /* gray-300 */
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8; /* gray-400 */
      }

      /* Utility to hide scrollbar but keep functionality */
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "lucide-react": "https://esm.sh/lucide-react@0.469.0?external=react",
    "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
    "react-dom": "https://esm.sh/react-dom@18.3.1",
    "recharts": "https://esm.sh/recharts@2.15.0?external=react,react-dom",
    "react/jsx-runtime": "https://esm.sh/react@18.3.1/jsx-runtime",
    "react": "https://esm.sh/react@18.3.1",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/"
  }
}
</script>
</head>
  <body class="bg-gray-50 text-gray-900 h-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useCallback, useRef, createContext, useContext, useMemo } from 'react';
      import { createRoot } from 'react-dom/client';
      import { 
        LayoutDashboard, PackagePlus, AlertTriangle, Menu, Settings, History, Share2, X, 
        Database, Upload, RefreshCw, Calendar, Trash2, Save, Plus, Minus,
        ArrowUpRight, ArrowDownLeft, Filter, Check, ChevronUp, ChevronDown,
        FileText, StickyNote, MessageSquarePlus, AlertCircle, CheckCircle2, ArrowUp, ArrowDown
      } from 'lucide-react';
      import { 
        BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell 
      } from 'recharts';

      // --- 1. Storage Logic & Constants ---
      
      const KEYS = {
        STOCKS: 'storekeeper_stocks_v1',
        TRANSACTIONS: 'storekeeper_transactions_v1',
        PREFERENCES: 'storekeeper_prefs_v1' // [New] Save view filters
      };

      const INITIAL_STOCK_NAMES = [
        "仙草", "機糖", "椰漿", "鮮奶", "乳酪", "紅茶", "鴨屎", "茉莉", "椰粉", 
        "黑糖", "珍珠", "冬瓜漿", "百香果醬", "葡萄醬", "芒果醬", "草莓醬", "芭樂醬", "青提醬"
      ];

      const DEFAULT_ORDER_QUANTITIES = {
        "仙草": 4, "機糖": 8, "椰漿": 4, "鮮奶": 2, "乳酪": 2, "紅茶": 3, 
        "鴨屎": 3, "茉莉": 6, "椰粉": 3, "黑糖": 3, "珍珠": 6, "冬瓜漿": 2, 
        "百香果醬": 2, "葡萄醬": 2, "芒果醬": 2, "草莓醬": 2, "芭樂醬": 2, "青提醬": 2
      };

      /**
       * Robust Storage Service to handle LocalStorage operations
       * Includes error handling for quota limits and JSON parsing
       */
      const StorageService = {
        save: (key, data) => {
          try {
            const stringified = JSON.stringify(data);
            localStorage.setItem(key, stringified);
          } catch (e) {
            console.error(`Failed to save to ${key}:`, e);
            if (e.name === 'QuotaExceededError' || e.code === 22) {
              alert("儲存空間已滿 (Storage Full)。請清除舊記錄或匯出備份。");
            }
          }
        },

        load: (key, fallbackValue = null) => {
          try {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : fallbackValue;
          } catch (e) {
            console.error(`Failed to load from ${key}:`, e);
            return fallbackValue;
          }
        }
      };

      // --- 2. Context ---
      const StockContext = createContext();
      const useStock = () => useContext(StockContext);

      // --- 3. Components ---

      // 3.1 Helper Components
      const StockStatusBadge = ({ status }) => {
        switch (status) {
          case 'CRITICAL':
            return <span className="px-2 py-1 rounded-full bg-red-100 text-red-800 text-xs font-bold border border-red-200">嚴重不足</span>;
          case 'WARNING':
            return <span className="px-2 py-1 rounded-full bg-yellow-100 text-yellow-800 text-xs font-bold border border-yellow-200">庫存偏低</span>;
          default:
            return <span className="px-2 py-1 rounded-full bg-green-100 text-green-800 text-xs font-bold border border-green-200">充足</span>;
        }
      };

      const FilterChip = ({ label, isActive, onClick }) => (
        <button
          onClick={onClick}
          className={`px-4 py-2 rounded-xl text-sm font-bold transition-all active:scale-95 flex items-center gap-1 border-2
            ${isActive 
              ? 'bg-brand-600 text-white border-brand-600 shadow-md shadow-brand-200' 
              : 'bg-white text-gray-600 border-gray-200 hover:border-gray-300'
            }`}
        >
          {isActive && <Check size={14} strokeWidth={3} />}
          {label}
        </button>
      );

      const QuickBtn = ({ onClick, type, label, isSecondary }) => {
        const baseClasses = "flex items-center justify-center rounded-xl font-bold transition-all active:scale-95 touch-manipulation select-none";
        const sizeClasses = isSecondary ? "w-12 h-12 text-sm" : "w-14 h-14 text-lg";
        
        let colorClasses = "";
        if (type === 'plus') {
          colorClasses = isSecondary 
            ? "bg-blue-100 text-blue-700 hover:bg-blue-200" 
            : "bg-blue-600 text-white shadow-md shadow-blue-200 hover:bg-blue-700";
        } else {
          colorClasses = "bg-white border-2 border-red-100 text-red-600 hover:bg-red-50";
        }

        return (
          <button onClick={onClick} className={`${baseClasses} ${sizeClasses} ${colorClasses}`}>
            {label}
          </button>
        );
      };

      // 3.2 View Components

      const InventoryView = () => {
        const { stocks, getStockStatus } = useStock();

        return (
          <div className="space-y-4">
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
              {stocks.map((stock) => {
                const status = getStockStatus(stock.quantity, stock.normalAmount);
                const percentage = Math.min(100, Math.round((stock.quantity / stock.normalAmount) * 100));
                
                let barColor = 'bg-green-500';
                if (status === 'WARNING') barColor = 'bg-yellow-500';
                if (status === 'CRITICAL') barColor = 'bg-red-500';

                return (
                  <div key={stock.id} className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-between">
                    <div className="flex justify-between items-start mb-3">
                      <h3 className="text-xl font-bold text-gray-800">{stock.name}</h3>
                      <StockStatusBadge status={status} />
                    </div>
                    
                    <div className="mb-2">
                      <div className="flex justify-between text-sm text-gray-500 mb-1">
                        <span>數量: <strong className="text-gray-900 text-lg">{stock.quantity}</strong></span>
                        <span>標準: {stock.normalAmount}</span>
                      </div>
                      <div className="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                        <div 
                          className={`${barColor} h-4 rounded-full transition-all duration-500 ease-out`} 
                          style={{ width: `${percentage}%` }}
                        />
                      </div>
                    </div>
                    
                    <div className="text-xs text-gray-400 text-right mt-1">
                      {percentage}% 存量
                    </div>
                  </div>
                );
              })}
            </div>
            {stocks.length === 0 && (
              <div className="text-center text-gray-500 mt-20">暫無庫存資料</div>
            )}
          </div>
        );
      };

      const EditStockView = () => {
        const { stocks, updateStock, updateStockConfig, transactions, addStock, deleteStock } = useStock();
        const [editingId, setEditingId] = useState(null);
        const [historyViewId, setHistoryViewId] = useState(null);
        const [isAdding, setIsAdding] = useState(false);
        
        // Form States
        const [newName, setNewName] = useState('');
        const [newNormal, setNewNormal] = useState(10);
        const [newOrderQty, setNewOrderQty] = useState(5);
        const [tempNormal, setTempNormal] = useState(10);
        const [tempOrderQty, setTempOrderQty] = useState(5);

        const [selectedDate, setSelectedDate] = useState(() => {
          const today = new Date();
          const yyyy = today.getFullYear();
          const mm = String(today.getMonth() + 1).padStart(2, '0');
          const dd = String(today.getDate()).padStart(2, '0');
          return `${yyyy}-${mm}-${dd}`;
        });

        const handleOpenSettings = (id, currentNormal, currentOrderQty) => {
          if (historyViewId === id) setHistoryViewId(null);
          setEditingId(id);
          setTempNormal(currentNormal);
          setTempOrderQty(currentOrderQty);
        };

        const handleSaveSettings = (id) => {
          updateStockConfig(id, { normalAmount: tempNormal, orderQuantity: tempOrderQty });
          setEditingId(null);
        };

        const handleDelete = (id) => {
          deleteStock(id);
          setEditingId(null);
        };

        const submitNewStock = () => {
          if (!newName.trim()) return;
          addStock(newName, newNormal, newOrderQty);
          setIsAdding(false);
          setNewName(''); setNewNormal(10); setNewOrderQty(5);
        };

        return (
          <div className="space-y-4 pb-4">
            {/* Date Selector */}
            <div className="sticky top-0 z-10 bg-gray-50 pb-2 pt-1">
              <div className="bg-white p-3 rounded-lg shadow-sm border border-gray-200 flex items-center gap-3">
                <div className="bg-brand-100 p-2 rounded-full text-brand-600">
                  <Calendar size={20} />
                </div>
                <div className="flex-1">
                  <label className="block text-xs font-bold text-gray-500 mb-1">入帳日期</label>
                  <input 
                    type="date" 
                    value={selectedDate}
                    onChange={(e) => setSelectedDate(e.target.value)}
                    className="w-full text-lg font-bold text-gray-800 bg-transparent focus:outline-none"
                  />
                </div>
              </div>
            </div>

            <div className="space-y-3">
              {stocks.map((stock) => (
                <div key={stock.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="text-xl font-bold text-gray-800">{stock.name}</h3>
                    <div className="flex gap-2">
                      <button 
                        onClick={() => setHistoryViewId(prev => prev === stock.id ? null : stock.id)}
                        className={`p-2 rounded-full transition-colors ${historyViewId === stock.id ? 'bg-purple-100 text-purple-600' : 'bg-gray-50 text-gray-400 hover:text-gray-600'}`}
                      >
                        <History size={20} />
                      </button>
                      <button 
                        onClick={() => handleOpenSettings(stock.id, stock.normalAmount, stock.orderQuantity)}
                        className={`p-2 rounded-full transition-colors ${editingId === stock.id ? 'bg-blue-100 text-blue-600' : 'bg-gray-50 text-gray-400 hover:text-gray-600'}`}
                      >
                        <Settings size={20} />
                      </button>
                    </div>
                  </div>

                  {/* History Panel */}
                  {historyViewId === stock.id && (
                    <div className="bg-purple-50 rounded-lg p-3 mb-4 border border-purple-100 animate-fade-in">
                        <div className="flex justify-between items-center mb-2 border-b border-purple-200 pb-1">
                          <h4 className="text-xs font-bold text-purple-800">最近記錄</h4>
                          <button onClick={() => setHistoryViewId(null)}><X size={16} className="text-purple-400"/></button>
                        </div>
                        <div className="max-h-48 overflow-y-auto">
                          <ul className="space-y-2">
                            {transactions.filter(t => t.stockId === stock.id).slice(0, 20).map(tx => (
                              <li key={tx.id} className="flex justify-between items-center text-sm bg-white p-2 rounded shadow-sm">
                                  <span className="text-gray-500 text-xs">{tx.date}</span>
                                  <span className={`font-bold font-mono ${tx.change > 0 ? 'text-blue-600' : 'text-orange-600'}`}>
                                    {tx.change > 0 ? '+' : ''}{tx.change}
                                  </span>
                              </li>
                            ))}
                          </ul>
                        </div>
                    </div>
                  )}

                  {/* Settings Mode vs Edit Mode */}
                  {editingId === stock.id ? (
                    <div className="bg-gray-50 p-4 rounded-lg mb-4 border border-gray-200 animate-fade-in">
                      <div className="grid grid-cols-2 gap-3 mb-4">
                        <div>
                          <label className="block text-xs font-bold text-gray-500 mb-1">標準數量</label>
                          <input type="number" value={tempNormal} onChange={(e) => setTempNormal(parseInt(e.target.value)||0)} className="w-full border border-gray-300 rounded-lg px-3 py-2 font-bold" />
                        </div>
                        <div>
                          <label className="block text-xs font-bold text-gray-500 mb-1">按鈕數值</label>
                          <input type="number" value={tempOrderQty} onChange={(e) => setTempOrderQty(parseInt(e.target.value)||0)} className="w-full border border-gray-300 rounded-lg px-3 py-2 font-bold" />
                        </div>
                      </div>
                      <div className="flex justify-between">
                        <button onClick={() => handleDelete(stock.id)} className="text-red-600 bg-red-50 px-3 py-2 rounded-lg text-sm font-bold flex items-center gap-1"><Trash2 size={16}/> 刪除</button>
                        <div className="flex gap-2">
                           <button onClick={() => setEditingId(null)} className="bg-white border border-gray-300 px-3 py-2 rounded-lg text-sm font-bold">取消</button>
                           <button onClick={() => handleSaveSettings(stock.id)} className="bg-brand-600 text-white px-3 py-2 rounded-lg text-sm font-bold flex items-center gap-1"><Save size={16}/> 儲存</button>
                        </div>
                      </div>
                    </div>
                  ) : (
                    <div className="flex items-center justify-between gap-2">
                       <div className="flex gap-2">
                         <QuickBtn onClick={() => updateStock(stock.id, -1, selectedDate)} type="minus" label="-1" />
                       </div>
                       <div className="flex flex-col items-center min-w-[60px]">
                          <span className="text-2xl font-black text-gray-800">{stock.quantity}</span>
                          <span className="text-xs text-gray-400">現量</span>
                       </div>
                       <div className="flex gap-2">
                         <QuickBtn onClick={() => updateStock(stock.id, 1, selectedDate)} type="plus" label="+1" />
                         <QuickBtn onClick={() => updateStock(stock.id, stock.orderQuantity, selectedDate)} type="plus" label={`+${stock.orderQuantity}`} isSecondary />
                       </div>
                    </div>
                  )}
                </div>
              ))}

              <button onClick={() => setIsAdding(true)} className="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 font-bold flex items-center justify-center gap-2 hover:bg-gray-50">
                <Plus size={24} /> 新增貨品
              </button>
            </div>

            {/* Add Stock Modal */}
            {isAdding && (
              <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm">
                <div className="bg-white rounded-2xl p-5 w-full max-w-sm shadow-2xl">
                  <h3 className="font-bold text-lg mb-4">新增貨品</h3>
                  <div className="space-y-4 mb-6">
                    <input type="text" placeholder="貨品名稱" value={newName} onChange={e => setNewName(e.target.value)} className="w-full border rounded-lg px-3 py-2 font-bold text-lg" />
                    <div className="flex gap-3">
                       <input type="number" placeholder="標準數量" value={newNormal} onChange={e => setNewNormal(parseInt(e.target.value))} className="w-full border rounded-lg px-3 py-2" />
                       <input type="number" placeholder="按鈕數值" value={newOrderQty} onChange={e => setNewOrderQty(parseInt(e.target.value))} className="w-full border rounded-lg px-3 py-2" />
                    </div>
                  </div>
                  <div className="flex gap-2">
                    <button onClick={() => setIsAdding(false)} className="flex-1 bg-gray-100 py-3 rounded-xl font-bold text-gray-600">取消</button>
                    <button onClick={submitNewStock} disabled={!newName.trim()} className="flex-1 bg-brand-600 py-3 rounded-xl font-bold text-white">確認</button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      };

      const AlertsView = () => {
        const { stocks, transactions, getStockStatus } = useStock();
        
        const alerts = useMemo(() => {
          const critical = [], warning = [];
          stocks.forEach(s => {
            const status = getStockStatus(s.quantity, s.normalAmount);
            if (status === 'CRITICAL') critical.push(s);
            else if (status === 'WARNING') warning.push(s);
          });
          return { critical, warning };
        }, [stocks, getStockStatus]);

        const chartData = useMemo(() => stocks.map(s => ({
          name: s.name, current: s.quantity, normal: s.normalAmount, status: getStockStatus(s.quantity, s.normalAmount)
        })), [stocks, getStockStatus]);

        const consumptionData = useMemo(() => {
          const stats = {};
          const todayTime = new Date().setHours(0,0,0,0);
          stocks.forEach(stock => {
            const outTx = transactions.filter(t => t.stockId === stock.id && t.change < 0);
            if (outTx.length === 0) { stats[stock.id] = "---"; return; }
            const totalUsed = outTx.reduce((acc, c) => acc + Math.abs(c.change), 0);
            const dates = outTx.map(t => new Date(t.date).getTime());
            const daysSpan = Math.ceil((todayTime - Math.min(...dates)) / (86400000)) + 1;
            const dailyAvg = totalUsed / daysSpan;
            const daysToFinish = dailyAvg > 0 ? stock.normalAmount / dailyAvg : 999;
            stats[stock.id] = daysToFinish > 999 ? "> 999" : daysToFinish < 10 ? daysToFinish.toFixed(1) : Math.round(daysToFinish);
          });
          return stats;
        }, [stocks, transactions]);

        return (
          <div className="space-y-8 pb-4">
            <div className="space-y-4">
              <h2 className="text-lg font-bold text-gray-700 border-l-4 border-gray-800 pl-3">需要關注</h2>
              {alerts.critical.length === 0 && alerts.warning.length === 0 && (
                 <div className="bg-green-50 border border-green-200 rounded-lg p-6 text-center text-green-800 font-bold">
                    <CheckCircle2 size={32} className="mx-auto mb-2"/> 全部庫存充足！
                 </div>
              )}
              {alerts.critical.map(s => (
                <div key={s.id} className="bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg flex items-center gap-3">
                  <AlertCircle className="text-red-600"/>
                  <div><h3 className="font-bold text-red-900">{s.name}</h3><p className="text-red-700 text-xs">嚴重不足: {s.quantity} (標準: {s.normalAmount})</p></div>
                </div>
              ))}
              {alerts.warning.map(s => (
                <div key={s.id} className="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-r-lg flex items-center gap-3">
                  <AlertTriangle className="text-yellow-600"/>
                  <div><h3 className="font-bold text-yellow-900">{s.name}</h3><p className="text-yellow-700 text-xs">庫存偏低: {s.quantity}</p></div>
                </div>
              ))}
            </div>

            <div className="h-[300px] bg-white p-2 rounded-xl border border-gray-100">
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={chartData} layout="vertical" margin={{left: 10, right: 10}}>
                  <XAxis type="number" hide />
                  <YAxis dataKey="name" type="category" width={60} tick={{fontSize: 12, fontWeight: 'bold'}} interval={0} />
                  <Tooltip />
                  <Bar dataKey="current" barSize={20} radius={[0,4,4,0]}>
                    {chartData.map((e, i) => <Cell key={i} fill={e.status === 'CRITICAL' ? '#ef4444' : e.status === 'WARNING' ? '#eab308' : '#22c55e'} />)}
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
            </div>
            
            <div>
               <h2 className="text-lg font-bold text-gray-700 border-l-4 border-indigo-500 pl-3 mb-4">消耗預測 (天數)</h2>
               <div className="grid grid-cols-3 gap-3">
                 {stocks.map(s => (
                   <div key={s.id} className="bg-white p-2 rounded-xl border text-center">
                      <div className="font-bold text-gray-800 text-sm truncate">{s.name}</div>
                      <div className="text-xl font-black text-indigo-600">{consumptionData[s.id]}</div>
                   </div>
                 ))}
               </div>
            </div>
          </div>
        );
      };

      const HistoryView = () => {
        const { transactions, stocks, updateTransactionNotes, prefs, updatePrefs } = useStock();
        
        // Initialize state from prefs or defaults
        const [sortDesc, setSortDesc] = useState(prefs?.sortDesc ?? true);
        const [filterType, setFilterType] = useState(prefs?.filterType ?? 'ALL');
        const [filterStockIds, setFilterStockIds] = useState([]); // Don't persist detailed filters for now, just main view prefs
        
        const [showFilters, setShowFilters] = useState(false);
        const [editingNote, setEditingNote] = useState(null);

        // Update prefs when local state changes
        useEffect(() => {
          updatePrefs({ sortDesc, filterType });
        }, [sortDesc, filterType, updatePrefs]);

        const filtered = useMemo(() => transactions.filter(tx => {
          if (filterStockIds.length > 0 && !filterStockIds.includes(tx.stockId)) return false;
          if (filterType === 'IN' && tx.change <= 0) return false;
          if (filterType === 'OUT' && tx.change >= 0) return false;
          return true;
        }).sort((a,b) => sortDesc ? b.timestamp - a.timestamp : a.timestamp - b.timestamp), [transactions, filterStockIds, filterType, sortDesc]);

        const grouped = useMemo(() => {
          const g = {};
          filtered.forEach(tx => {
            const k = tx.date ? tx.date.slice(0,7) : 'Unknown';
            if (!g[k]) g[k] = [];
            g[k].push(tx);
          });
          return g;
        }, [filtered]);

        return (
          <div className="space-y-4 pb-4">
             {/* Filter Bar */}
             <div className="sticky top-0 z-30 bg-gray-50/95 backdrop-blur shadow-sm -mx-4 px-4 py-2 mb-2">
                <div className="flex gap-2">
                   <button onClick={() => setSortDesc(!sortDesc)} className="w-10 h-10 flex items-center justify-center bg-white rounded-lg border shadow-sm">{sortDesc ? <ArrowDown size={18}/> : <ArrowUp size={18}/>}</button>
                   <div className="flex-1 bg-gray-200 p-1 rounded-lg flex text-xs font-bold text-gray-600">
                      {['ALL', 'IN', 'OUT'].map(t => (
                        <button key={t} onClick={() => setFilterType(t)} className={`flex-1 rounded flex items-center justify-center ${filterType===t ? 'bg-white shadow-sm text-gray-900' : ''}`}>
                          {t === 'ALL' ? '全部' : t === 'IN' ? '入貨' : '出貨'}
                        </button>
                      ))}
                   </div>
                </div>
                <div className="mt-2 flex items-center gap-2 overflow-x-auto no-scrollbar pb-1">
                   <button onClick={() => setShowFilters(!showFilters)} className={`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-bold border ${showFilters ? 'bg-brand-50 border-brand-200 text-brand-600' : 'bg-white'}`}>
                      <Filter size={14}/> 篩選
                   </button>
                   {filterStockIds.length > 0 && <button onClick={() => setFilterStockIds([])} className="text-xs text-red-500 font-bold px-2">清除 ({filterStockIds.length})</button>}
                </div>
                {showFilters && (
                  <div className="mt-2 flex flex-wrap gap-2 animate-fade-in">
                     {stocks.map(s => (
                       <FilterChip key={s.id} label={s.name} isActive={filterStockIds.includes(s.id)} onClick={() => setFilterStockIds(prev => prev.includes(s.id) ? prev.filter(i=>i!==s.id) : [...prev, s.id])} />
                     ))}
                  </div>
                )}
             </div>

             {/* List */}
             {Object.keys(grouped).length === 0 && <div className="text-center text-gray-400 py-10">暫無記錄</div>}
             
             {Object.keys(grouped).sort((a,b) => sortDesc ? b.localeCompare(a) : a.localeCompare(b)).map(month => (
               <div key={month} className="space-y-2">
                  <div className="sticky top-[100px] z-20 inline-block bg-brand-500 text-white px-2 py-1 rounded text-xs font-bold shadow-sm">{month}</div>
                  <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    {grouped[month].map((tx, i) => (
                       <div key={tx.id} className={`p-3 ${i !== grouped[month].length-1 ? 'border-b border-gray-50' : ''}`}>
                          <div className="flex justify-between items-center">
                             <div className="flex items-center gap-3">
                                <div className={`w-10 h-10 rounded-xl flex items-center justify-center border ${tx.change>0 ? 'bg-blue-50 border-blue-100 text-blue-600' : 'bg-orange-50 border-orange-100 text-orange-600'}`}>
                                  {tx.change>0 ? <ArrowUpRight size={20}/> : <ArrowDownLeft size={20}/>}
                                </div>
                                <div>
                                  <div className="font-bold text-gray-800">{tx.stockName}</div>
                                  <div className="text-[10px] text-gray-400">{tx.date}</div>
                                </div>
                             </div>
                             <div className={`text-xl font-black font-mono ${tx.change>0 ? 'text-blue-600' : 'text-orange-600'}`}>
                               {tx.change>0?'+':''}{tx.change}
                             </div>
                          </div>
                          <div className="mt-2 pl-[52px]">
                             {tx.notes ? (
                               <div onClick={() => setEditingNote({id: tx.id, text: tx.notes})} className="bg-yellow-50 p-2 rounded-lg text-xs text-yellow-800 flex gap-1 items-start cursor-pointer"><StickyNote size={12} className="shrink-0 mt-0.5"/> {tx.notes}</div>
                             ) : (
                               <button onClick={() => setEditingNote({id: tx.id, text: ''})} className="text-[10px] text-gray-400 flex items-center gap-1 bg-gray-50 px-2 py-1 rounded"><MessageSquarePlus size={12}/> 備註</button>
                             )}
                          </div>
                       </div>
                    ))}
                  </div>
               </div>
             ))}

             {/* Note Modal */}
             {editingNote && (
               <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm">
                 <div className="bg-white rounded-2xl p-4 w-full max-w-sm">
                    <h3 className="font-bold text-lg mb-2">編輯備註</h3>
                    <textarea className="w-full border rounded-xl p-3 min-h-[100px]" value={editingNote.text} onChange={e => setEditingNote({...editingNote, text: e.target.value})} autoFocus></textarea>
                    <div className="flex justify-end gap-2 mt-3">
                       <button onClick={() => setEditingNote(null)} className="px-3 py-2 bg-gray-100 rounded-lg text-sm font-bold">取消</button>
                       <button onClick={() => {updateTransactionNotes(editingNote.id, editingNote.text); setEditingNote(null)}} className="px-3 py-2 bg-brand-600 text-white rounded-lg text-sm font-bold">儲存</button>
                    </div>
                 </div>
               </div>
             )}
          </div>
        );
      };

      // --- 4. Main App Logic ---
      function App() {
        // -- Global State Variables --
        const [stocks, setStocks] = useState([]);
        const [transactions, setTransactions] = useState([]);
        const [prefs, setPrefs] = useState({ sortDesc: true, filterType: 'ALL' });
        
        const [currentView, setCurrentView] = useState('INVENTORY');
        const [isLoaded, setIsLoaded] = useState(false);
        const [isSettingsOpen, setIsSettingsOpen] = useState(false);
        
        // Refs
        const fileInputRef = useRef(null);

        // -- Helper Functions (Logic) --
        const generateInitialStocks = () => {
          return INITIAL_STOCK_NAMES.map((name, index) => ({
            id: `stock-${index}`,
            name,
            quantity: 0,
            normalAmount: 10,
            orderQuantity: DEFAULT_ORDER_QUANTITIES[name] || 5,
            orderCost: 0
          }));
        };

        const getStockStatus = (current, normal) => {
          const ratio = current / normal;
          if (ratio < 0.3) return 'CRITICAL';
          if (ratio < 0.5) return 'WARNING';
          return 'NORMAL';
        };

        // -- Reusable Load Data Logic --
        const refreshData = useCallback(() => {
            try {
                // 1. Load Stocks
                const savedStocks = StorageService.load(KEYS.STOCKS);
                if (savedStocks) {
                    const migratedStocks = savedStocks.map(s => {
                        const targetDefault = DEFAULT_ORDER_QUANTITIES[s.name] || 5;
                        const currentOrderQty = s.orderQuantity !== undefined ? s.orderQuantity : 5;
                        return {
                        ...s,
                        orderQuantity: currentOrderQty === 5 ? targetDefault : currentOrderQty,
                        orderCost: s.orderCost ?? 0
                        };
                    });
                    setStocks(migratedStocks);
                } else {
                    // Only set initial if first run (LS is empty)
                    // If we are just refreshing, we respect LS, but if LS is null (rare), reset.
                    setStocks(generateInitialStocks());
                }

                // 2. Load Transactions
                const savedTransactions = StorageService.load(KEYS.TRANSACTIONS, []);
                setTransactions(savedTransactions);

                // 3. Load Preferences
                const savedPrefs = StorageService.load(KEYS.PREFERENCES, { sortDesc: true, filterType: 'ALL' });
                setPrefs(savedPrefs);
            } catch (e) {
                console.error("Error refreshing data:", e);
            }
        }, []);

        // -- Load Data (Effects) --
        
        // 1. Initial Load
        useEffect(() => {
          refreshData();
          setIsLoaded(true);
        }, [refreshData]);

        // 2. Refresh on Page Turn (View Change)
        useEffect(() => {
            if (isLoaded) {
                refreshData();
            }
        }, [currentView, isLoaded, refreshData]);

        // -- Save Data (Effects) --
        
        // Save Stocks
        useEffect(() => {
          if (isLoaded) {
            StorageService.save(KEYS.STOCKS, stocks);
          }
        }, [stocks, isLoaded]);

        // Save Transactions
        useEffect(() => {
          if (isLoaded) {
            // Keep only last 1000 transactions to prevent localStorage quota issues
            const recentTransactions = transactions.slice(0, 1000);
            StorageService.save(KEYS.TRANSACTIONS, recentTransactions);
          }
        }, [transactions, isLoaded]);

        // Save Preferences
        useEffect(() => {
          if (isLoaded) {
            StorageService.save(KEYS.PREFERENCES, prefs);
          }
        }, [prefs, isLoaded]);


        // -- Logic Functions --
        
        const updateStock = useCallback((id, delta, date, cost) => {
            const stock = stocks.find(s => s.id === id);
            if (!stock) return;

            setStocks(prev => prev.map(item => {
                if (item.id === id) {
                    const newQty = Math.max(0, item.quantity + delta);
                    return { ...item, quantity: newQty };
                }
                return item;
            }));

            const newTx = {
                id: Date.now().toString() + Math.random().toString().slice(2),
                stockId: id,
                stockName: stock.name,
                change: delta,
                cost: cost,
                date: date || new Date().toISOString().split('T')[0],
                timestamp: Date.now()
            };
            setTransactions(prev => [newTx, ...prev]);
        }, [stocks]);

        const updateStockConfig = useCallback((id, config) => {
            setStocks(prev => prev.map(item => {
                if (item.id === id) {
                    return { 
                        ...item, 
                        normalAmount: config.normalAmount !== undefined ? Math.max(1, config.normalAmount) : item.normalAmount,
                        orderQuantity: config.orderQuantity !== undefined ? Math.max(1, config.orderQuantity) : item.orderQuantity,
                        orderCost: config.orderCost !== undefined ? Math.max(0, config.orderCost) : item.orderCost
                    };
                }
                return item;
            }));
        }, []);

        const updateTransactionNotes = useCallback((id, notes) => {
            setTransactions(prev => prev.map(tx => {
                if (tx.id === id) return { ...tx, notes };
                return tx;
            }));
        }, []);

        const updatePrefs = useCallback((newPrefs) => {
           setPrefs(prev => ({...prev, ...newPrefs}));
        }, []);

        const addStock = useCallback((name, normalAmount, orderQuantity) => {
            setStocks(prev => [
                ...prev,
                {
                    id: `stock-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    name,
                    quantity: 0,
                    normalAmount: Math.max(1, normalAmount),
                    orderQuantity: Math.max(1, orderQuantity),
                    orderCost: 0
                }
            ]);
        }, []);

        const deleteStock = useCallback((id) => {
            if (!window.confirm("確定要刪除此貨品嗎？歷史記錄將會保留。")) return;
            setStocks(prev => prev.filter(s => s.id !== id));
        }, []);

        const handleBackup = async () => {
            const data = {
                app: "StoreKeeper",
                version: "1.0",
                createdAt: new Date().toISOString(),
                stocks,
                transactions
            };
            const jsonString = JSON.stringify(data, null, 2);
            const fileName = `store_backup_${new Date().toISOString().slice(0, 10)}.json`;
            const file = new File([jsonString], fileName, { type: 'application/json' });

            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        title: 'StoreKeeper Backup',
                        text: `Backup created on ${new Date().toLocaleDateString()}`,
                        files: [file]
                    });
                    return;
                } catch (error) {
                   // Ignore abort errors
                }
            }
            
            // Fallback download
            const url = URL.createObjectURL(file);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        };

        const handleImportClick = () => {
            fileInputRef.current?.click();
        };

        const handleFileChange = async (event) => {
            const file = event.target.files?.[0];
            if (!file) return;

            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                if (data.app !== 'StoreKeeper' || !Array.isArray(data.stocks)) {
                     throw new Error("檔案格式不正確 (Invalid Format)");
                }

                if (window.confirm("警告：還原備份將會覆蓋現有的所有資料。是否繼續？")) {
                    setStocks(data.stocks);
                    setTransactions(data.transactions || []);
                    setIsSettingsOpen(false);
                    alert("還原成功！");
                }
            } catch (error) {
                alert("匯入失敗: " + error.message);
            } finally {
                if (fileInputRef.current) fileInputRef.current.value = '';
            }
        };

        // -- Context Value --
        const contextValue = {
            stocks,
            transactions,
            prefs,
            updateStock,
            updateStockConfig,
            updateTransactionNotes,
            updatePrefs,
            addStock,
            deleteStock,
            getStockStatus,
            handleBackup,
            handleImportClick,
            handleFileChange,
            fileInputRef
        };

        // -- Render --
        if (!isLoaded) return <div className="flex items-center justify-center h-screen text-gray-400">載入中...</div>;

        return (
          <StockContext.Provider value={contextValue}>
            <div className="flex flex-col h-[100dvh] bg-gray-50 overflow-hidden">
               {/* Header */}
               <header className="bg-white shadow-sm px-4 py-3 flex items-center justify-between z-10 shrink-0 relative">
                <h1 className="text-xl font-bold text-gray-800 truncate">
                  {currentView === 'INVENTORY' && '庫存一覽 (Stock)'}
                  {currentView === 'EDIT' && '出入貨管理 (Edit)'}
                  {currentView === 'ALERTS' && '警報與統計 (Alerts)'}
                  {currentView === 'HISTORY' && '出入貨記錄 (History)'}
                </h1>
                <button 
                  onClick={() => setIsSettingsOpen(true)}
                  className="text-gray-500 hover:text-gray-700 p-1.5 rounded-full hover:bg-gray-100 transition-colors"
                >
                   <Settings size={24} />
                </button>
              </header>

              {/* Main Content Area */}
              {/* Added 'overscroll-none' to prevent pull-to-refresh on mobile */}
              <main className="flex-1 overflow-y-auto overflow-x-hidden p-4 pb-4 bg-gray-50 relative overscroll-none">
                 {currentView === 'INVENTORY' && <InventoryView />}
                 {currentView === 'EDIT' && <EditStockView />}
                 {currentView === 'ALERTS' && <AlertsView />}
                 {currentView === 'HISTORY' && <HistoryView />}
              </main>

              {/* Navigation */}
              <nav className="bg-white border-t border-gray-200 shrink-0 w-full z-50 pb-safe shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] relative">
                <div className="flex justify-between items-center h-16 px-2">
                  <NavButton active={currentView === 'INVENTORY'} onClick={() => setCurrentView('INVENTORY')} icon={<LayoutDashboard size={24} />} label="查看" />
                  <NavButton active={currentView === 'EDIT'} onClick={() => setCurrentView('EDIT')} icon={<PackagePlus size={24} />} label="出入貨" />
                  <NavButton active={currentView === 'HISTORY'} onClick={() => setCurrentView('HISTORY')} icon={<History size={24} />} label="記錄" />
                  <NavButton active={currentView === 'ALERTS'} onClick={() => setCurrentView('ALERTS')} icon={<AlertTriangle size={24} />} label="警報" />
                </div>
              </nav>

              {/* Settings Modal */}
              {isSettingsOpen && (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm animate-fade-in">
                   <div className="bg-white rounded-2xl p-5 w-full max-w-sm shadow-2xl">
                      <div className="flex justify-between items-center mb-4">
                         <h3 className="font-bold text-lg text-gray-800">設定 (Settings)</h3>
                         <button onClick={() => setIsSettingsOpen(false)}><X size={24} className="text-gray-400"/></button>
                      </div>
                      <div className="space-y-4">
                         <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                            <h4 className="font-bold text-blue-800 mb-2 flex items-center gap-2"><Database size={18} /> 備份數據</h4>
                            <button onClick={handleBackup} className="w-full flex items-center justify-center gap-2 p-3 bg-white text-blue-600 rounded-lg border border-blue-200 font-bold shadow-sm"><Share2 size={18}/> 匯出備份</button>
                         </div>
                         <div className="bg-orange-50 p-4 rounded-xl border border-orange-100">
                            <h4 className="font-bold text-orange-800 mb-2 flex items-center gap-2"><RefreshCw size={18} /> 還原數據</h4>
                            <input type="file" ref={fileInputRef} onChange={handleFileChange} accept=".json" className="hidden" />
                            <button onClick={handleImportClick} className="w-full flex items-center justify-center gap-2 p-3 bg-white text-orange-600 rounded-lg border border-orange-200 font-bold shadow-sm"><Upload size={18}/> 匯入備份</button>
                         </div>
                         <div className="text-center"><p className="text-xs text-gray-400">StoreKeeper v1.2.1</p></div>
                      </div>
                   </div>
                </div>
              )}
            </div>
          </StockContext.Provider>
        );
      }

      const NavButton = ({ active, onClick, icon, label }) => (
        <button 
          onClick={onClick}
          className={`flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors duration-200 ${active ? 'text-brand-600 bg-brand-50' : 'text-gray-400 hover:text-gray-600'}`}
        >
          {icon}
          <span className="text-xs font-bold">{label}</span>
        </button>
      );

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
